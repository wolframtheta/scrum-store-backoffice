<div class="catalog-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <div class="header">
    <div>
      <h1>{{ 'catalog.title' | translate }}</h1>
      <p class="subtitle">{{ 'catalog.subtitle' | translate }}</p>
    </div>
    <div class="header-actions">
      <p-button
        icon="pi pi-plus"
        [label]="'catalog.actions.create' | translate"
        severity="primary"
        (click)="openCreateDialog()"
      />
    </div>
  </div>

  <!-- Formulari -->
  <app-article-form
    [visible]="showFormDialog()"
    [article]="editingArticle()"
    (visibleChange)="showFormDialog.set($event)"
    (save)="onSaveArticle($event)"
  />

  <!-- Filtres -->
  <form [formGroup]="filtersForm" class="filters">
    <p-inputGroup class="search-input">
      <p-inputGroupAddon>
        <i class="pi pi-search"></i>
      </p-inputGroupAddon>
      <input
        type="text"
        pInputText
        formControlName="search"
        [placeholder]="'catalog.filters.searchPlaceholder' | translate"
        (keyup.enter)="onSearch()"
      />
      <p-button
        icon="pi pi-search"
        [label]="'common.search' | translate"
        (click)="onSearch()"
      />
    </p-inputGroup>

    <p-inputGroup class="filter-group">
      <p-inputGroupAddon>
        <i class="pi pi-filter"></i>
      </p-inputGroupAddon>
      <p-multiSelect
        formControlName="showcaseFilter"
        [options]="showcaseFilterOptions"
        [placeholder]="'catalog.filters.showcase' | translate"
        (onChange)="onShowcaseFilterChange()"
        [showClear]="true"
        [style]="{ width: '100%' }"
        display="chip">
      </p-multiSelect>
    </p-inputGroup>

    <p-inputGroup class="filter-group">
      <p-inputGroupAddon>
        <i class="pi pi-tag"></i>
      </p-inputGroupAddon>
      <p-multiSelect
        formControlName="categoryFilter"
        [options]="categories()"
        [placeholder]="'catalog.filters.category' | translate"
        [showClear]="true"
        [style]="{ width: '100%' }"
        display="chip">
      </p-multiSelect>
    </p-inputGroup>

    <p-button
      icon="pi pi-filter-slash"
      [label]="'common.clear' | translate"
      [text]="true"
      (click)="clearFilters()"
    />
  </form>

  <!-- Accions massives -->
  @if (hasSelection()) {
    <div class="batch-actions">
      <span class="selection-count">{{ getSelectedCount() }} {{ 'catalog.batch.selected' | translate }}</span>
      <p-button
        icon="pi pi-eye"
        [label]="'catalog.batch.addToShowcase' | translate"
        severity="success"
        size="small"
        (click)="batchToggleShowcase(true)"
      />
      <p-button
        icon="pi pi-eye-slash"
        [label]="'catalog.batch.removeFromShowcase' | translate"
        severity="warn"
        size="small"
        (click)="batchToggleShowcase(false)"
      />
      <p-button
        icon="pi pi-leaf"
        [label]="'catalog.batch.markSeasonal' | translate"
        severity="info"
        size="small"
        (click)="batchToggleSeasonal(true)"
      />
      <p-button
        icon="pi pi-leaf"
        [label]="'catalog.batch.unmarkSeasonal' | translate"
        severity="secondary"
        size="small"
        (click)="batchToggleSeasonal(false)"
      />
      <p-button
        icon="pi pi-check-circle"
        [label]="'catalog.batch.markEco' | translate"
        severity="success"
        size="small"
        (click)="batchToggleEco(true)"
      />
      <p-button
        icon="pi pi-times-circle"
        [label]="'catalog.batch.unmarkEco' | translate"
        severity="secondary"
        size="small"
        (click)="batchToggleEco(false)"
      />
      <p-button
        icon="pi pi-trash"
        [label]="'catalog.batch.delete' | translate"
        severity="danger"
        size="small"
        (click)="batchDelete()"
      />
    </div>
  }

  <!-- Taula -->
  <p-table
    [value]="catalogService.articles()"
    [loading]="catalogService.isLoading()"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="{{ 'common.showing' | translate }} {first} {{ 'common.to' | translate }} {last} {{ 'common.of' | translate }} {totalRecords} {{ 'common.records' | translate }}"
    responsiveLayout="scroll"
    [selection]="selectedArticles()"
    (selectionChange)="onSelectionChange($event)"
    dataKey="id">

    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th>{{ 'catalog.table.category' | translate }}</th>
        <th>{{ 'catalog.table.product' | translate }}</th>
        <th>{{ 'catalog.table.variety' | translate }}</th>
        <th>{{ 'catalog.table.producer' | translate }}</th>
        <th>{{ 'catalog.table.city' | translate }}</th>
        <th>{{ 'catalog.table.priceWithoutTax' | translate }}</th>
        <th>{{ 'catalog.table.taxRate' | translate }}</th>
        <th>{{ 'catalog.table.priceWithTax' | translate }}</th>
        <th>{{ 'catalog.table.unit' | translate }}</th>
        <th>{{ 'catalog.table.eco' | translate }}</th>
        <th>{{ 'catalog.table.seasonal' | translate }}</th>
        <th>{{ 'catalog.table.showcase' | translate }}</th>
        <th style="width: 12rem">{{ 'common.actions' | translate }}</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-article>
      <tr (click)="goToDetail(article)" style="cursor: pointer;">
        <td (click)="$event.stopPropagation()">
          <p-tableCheckbox [value]="article"></p-tableCheckbox>
        </td>
        <td>
          <p-tag [value]="article.category" severity="info" />
        </td>
        <td>
          <strong>{{ article.product }}</strong>
          @if (article.description) {
            <br />
            <small class="text-secondary">{{ article.description }}</small>
          }
        </td>
        <td>
          @if (article.variety) {
            <p-tag [value]="article.variety" severity="secondary" />
          } @else {
            <span class="text-secondary">â€”</span>
          }
        </td>
        <td>{{ article.producerName || 'â€”' }}</td>
        <td>{{ article.city || 'â€”' }}</td>
        <td class="text-right">
          @if (article.currentPeriodPrice !== undefined) {
            <div>
              <strong>{{ formatPrice(article.currentPeriodPrice) }}</strong>
              <small class="text-secondary" style="display: block; font-size: 0.85rem;">
                (Base: {{ formatPrice(article.pricePerUnit) }})
              </small>
            </div>
          } @else {
            <strong>{{ formatPrice(article.pricePerUnit) }}</strong>
          }
        </td>
        <td class="text-right">
          @if (article.taxRate) {
            <span>{{ article.taxRate }}%</span>
          } @else {
            <span class="text-secondary">â€”</span>
          }
        </td>
        <td class="text-right">
          @if (article.taxRate) {
            @if (article.currentPeriodPrice !== undefined) {
              <strong>{{ formatPrice(article.currentPeriodPrice * (1 + article.taxRate / 100)) }}</strong>
            } @else {
              <strong>{{ formatPrice(article.pricePerUnit * (1 + article.taxRate / 100)) }}</strong>
            }
          } @else {
            @if (article.currentPeriodPrice !== undefined) {
              <strong>{{ formatPrice(article.currentPeriodPrice) }}</strong>
            } @else {
              <strong>{{ formatPrice(article.pricePerUnit) }}</strong>
            }
          }
        </td>
        <td>
          <p-tag [value]="article.unitMeasure" severity="secondary"></p-tag>
        </td>
        <td>
          @if (article.isEco) {
            <i class="fa fa-recycle eco-icon" title="EcolÃ²gic"></i>
          } @else {
            <span class="text-secondary">â€”</span>
          }
        </td>
        <td>
          @if (article.isSeasonal) {
            <p-tag
              value="ðŸŒ± {{ 'catalog.table.seasonalYes' | translate }}"
              severity="success"
              icon="pi pi-leaf"
            />
          } @else {
            <p-tag
              [value]="'catalog.table.seasonalNo' | translate"
              severity="secondary"
            />
          }
        </td>
        <td>
          <p-tag
            [value]="getShowcaseLabel(article.inShowcase) | translate"
            [severity]="getShowcaseSeverity(article.inShowcase)">
          </p-tag>
        </td>
        <td (click)="$event.stopPropagation()">
          <div class="action-buttons">
            @if (article.inShowcase) {
              <p-button
                icon="pi pi-eye-slash"
                [text]="true"
                [rounded]="true"
                severity="warn"
                size="small"
                (click)="toggleShowcase(article)"
                pTooltip="{{ 'catalog.actions.removeFromShowcase' | translate }}"
              />
            } @else {
              <p-button
                icon="pi pi-eye"
                [text]="true"
                [rounded]="true"
                severity="success"
                size="small"
                (click)="toggleShowcase(article)"
                pTooltip="{{ 'catalog.actions.addToShowcase' | translate }}"
              />
            }
            <p-button
              icon="pi pi-eye"
              [text]="true"
              [rounded]="true"
              severity="info"
              size="small"
              [routerLink]="['/catalog', article.id]"
              pTooltip="{{ 'common.view' | translate }}"
            />
            <p-button
              icon="pi pi-pencil"
              [text]="true"
              [rounded]="true"
              severity="secondary"
              size="small"
              (click)="openEditDialog(article)"
              pTooltip="{{ 'common.edit' | translate }}"
            />
            <p-button
              icon="pi pi-trash"
              [text]="true"
              [rounded]="true"
              severity="danger"
              size="small"
              (click)="deleteArticle(article)"
              pTooltip="{{ 'common.delete' | translate }}"
            />
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="12" class="text-center">
          <div class="empty-state">
            <i class="pi pi-inbox" style="font-size: 3rem; color: var(--text-color-secondary)"></i>
            <p>{{ 'catalog.empty' | translate }}</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

