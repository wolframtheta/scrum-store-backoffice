<div class="period-form-page">
  <p-toast />
  
  <div class="page-header">
    <div class="header-content">
      <p-button
        icon="pi pi-arrow-left"
        [text]="true"
        severity="secondary"
        (onClick)="onCancel()"
        [pTooltip]="'common.back' | translate"
      />
      <h1 class="page-title">
        {{ (isEditMode() ? 'periods.edit' : 'periods.create') | translate }}
      </h1>
    </div>
  </div>

  <div class="form-container">
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="form-content">
        <!-- Proveïdor (només si no hi ha supplierId) -->
        @if (!supplierId()) {
          <div class="form-field">
            <label for="supplierId">{{ 'periods.form.supplier' | translate }} *</label>
            <p-select
              id="supplierId"
              formControlName="supplierId"
              [options]="suppliers()"
              optionLabel="name"
              optionValue="id"
              [placeholder]="'periods.form.selectSupplier' | translate"
              [style]="{ width: '100%' }"
              [class.ng-invalid]="form.get('supplierId')?.invalid && form.get('supplierId')?.touched"
            />
            @if (form.get('supplierId')?.invalid && form.get('supplierId')?.touched) {
              <small class="error-message">
                {{ 'validation.required' | translate }}
              </small>
            }
          </div>
        }

        <!-- Nom -->
        <div class="form-field">
          <label for="name">{{ 'periods.form.name' | translate }} *</label>
          <input
            id="name"
            type="text"
            pInputText
            formControlName="name"
            [class.ng-invalid]="form.get('name')?.invalid && form.get('name')?.touched"
          />
          @if (form.get('name')?.invalid && form.get('name')?.touched) {
            <small class="error-message">
              {{ 'validation.required' | translate }}
            </small>
          }
        </div>

        <!-- Dates -->
        <div class="form-row">
          <div class="form-field date-range-field">
            <label>{{ 'periods.form.dateRange' | translate }} *</label>
            <p-datePicker
              [(ngModel)]="dateRange"
              (ngModelChange)="onDateRangeChange($event)"
              [ngModelOptions]="{standalone: true}"
              selectionMode="range"
              [inline]="true"
              dateFormat="dd/mm/yy"
              [showIcon]="false"
              [firstDayOfWeek]="1"
              [class.ng-invalid]="(form.get('startDate')?.invalid || form.get('endDate')?.invalid) && (form.get('startDate')?.touched || form.get('endDate')?.touched)"
              [style]="{ width: '100%' }"
            />
            @if ((form.get('startDate')?.invalid || form.get('endDate')?.invalid) && (form.get('startDate')?.touched || form.get('endDate')?.touched)) {
              <small class="error-message">
                {{ 'validation.required' | translate }}
              </small>
            }
          </div>

          <div class="form-field">
            <label for="deliveryDate">{{ 'periods.form.deliveryDate' | translate }} *</label>
            <p-datePicker
              id="deliveryDate"
              formControlName="deliveryDate"
              [inline]="false"
              [showIcon]="false"
              [showOnFocus]="true"
              [appendTo]="'body'"
              [inputStyle]="{ cursor: 'pointer' }"
              dateFormat="dd/mm/yy"
              [minDate]="getMinDeliveryDate()"
              [firstDayOfWeek]="1"
              [class.ng-invalid]="form.get('deliveryDate')?.invalid && form.get('deliveryDate')?.touched"
              [style]="{ width: '100%' }"
            />
            @if (form.get('deliveryDate')?.invalid && form.get('deliveryDate')?.touched) {
              <small class="error-message">
                @if (form.get('deliveryDate')?.errors?.['deliveryDateAfterEnd']) {
                  {{ 'periods.form.deliveryDateAfterEnd' | translate }}
                } @else {
                  {{ 'validation.required' | translate }}
                }
              </small>
            }
          </div>
        </div>

        <!-- Recurrència -->
        <div class="form-field">
          <label for="recurrence">{{ 'periods.form.recurrence' | translate }} *</label>
          <p-select
            id="recurrence"
            formControlName="recurrence"
            [options]="recurrenceOptions"
            optionLabel="label"
            optionValue="value"
            [style]="{ width: '100%' }"
          />
        </div>

        <!-- Articles -->
        <div class="form-section">
          <p-accordion [(value)]="accordionValue">
            <p-accordion-panel value="articles">
              <p-accordion-header>
                {{ articlesHeader }}
              </p-accordion-header>
              <p-accordion-content>
                <!-- Afegir article -->
                <div class="add-article-section">
                <p-autoComplete
                  [suggestions]="filteredArticles()"
                  (completeMethod)="filterArticles($event)"
                  (onSelect)="onArticleSelect($event)"
                  optionLabel="product"
                  dataKey="id"
                  [placeholder]="'periods.form.searchArticle' | translate"
                  [style]="{ width: '100%' }"
                  [inputStyle]="{ width: '100%' }"
                >
                  <ng-template let-article pTemplate="item">
                    <div class="article-option">
                      <strong>{{ article.product }}</strong>
                      @if (article.variety) {
                        <span> - {{ article.variety }}</span>
                      }
                      <small>{{ article.category }}</small>
                    </div>
                  </ng-template>
                </p-autoComplete>
                <p-button
                  [label]="'periods.form.addArticle' | translate"
                  icon="pi pi-plus"
                  (onClick)="addArticleToPeriod()"
                  [disabled]="!selectedArticle()"
                />
              </div>

              <!-- Llista d'articles del període -->
              @if (periodArticles.length > 0) {
                <div class="articles-table">
                  <p-table [value]="periodArticles.controls" styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                      <tr>
                        <th>{{ 'periods.form.article' | translate }}</th>
                        <th>{{ 'periods.form.unit' | translate }}</th>
                        <th>{{ 'periods.form.price' | translate }}</th>
                        <th class="actions-column"></th>
                      </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-control let-i="rowIndex">
                      <tr [formGroup]="control">
                        <td>{{ getArticleName(control.get('articleId')?.value) }}</td>
                        <td>{{ getArticleUnit(control.get('articleId')?.value) }}</td>
                        <td>
                          <p-inputNumber
                            formControlName="pricePerUnit"
                            [min]="0"
                            [maxFractionDigits]="2"
                            [style]="{ width: '100%' }"
                            [class.ng-invalid]="control.get('pricePerUnit')?.invalid && control.get('pricePerUnit')?.touched"
                          />
                          @if (control.get('pricePerUnit')?.invalid && control.get('pricePerUnit')?.touched) {
                            <small class="error-message">
                              {{ 'validation.required' | translate }}
                            </small>
                          }
                        </td>
                        <td class="actions-column">
                          <p-button
                            icon="pi pi-trash"
                            [rounded]="true"
                            [text]="true"
                            severity="danger"
                            (onClick)="removeArticle(i)"
                            [pTooltip]="'common.delete' | translate"
                          />
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              } @else {
                <p class="no-articles">{{ 'periods.form.noArticles' | translate }}</p>
              }
              </p-accordion-content>
            </p-accordion-panel>
          </p-accordion>
        </div>
      </div>

      <div class="form-footer">
        <p-button
          [label]="'common.cancel' | translate"
          severity="secondary"
          [outlined]="true"
          (onClick)="onCancel()"
        />
        <p-button
          [label]="'common.save' | translate"
          icon="pi pi-check"
          type="submit"
          [disabled]="!form.valid || isLoading()"
          [loading]="isLoading()"
        />
      </div>
    </form>
  </div>
</div>

