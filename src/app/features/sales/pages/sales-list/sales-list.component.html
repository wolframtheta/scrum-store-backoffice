<div class="sales-container">
  <p-toast />
  <p-confirmDialog />

  <div class="header">
    <div>
      <h1>{{ 'sales.title' | translate }}</h1>
      <p class="subtitle">{{ 'sales.subtitle' | translate }}</p>
    </div>
    @if (someSelectableSelected()) {
      <div class="header-actions">
        <p-button
          [label]="'sales.actions.markSelectedAsPaid' | translate"
          icon="pi pi-check-circle"
          severity="success"
          (onClick)="markSelectedAsPaid()"
          [loading]="salesService.isLoading()"
        />
      </div>
    }
  </div>

  <!-- Filtres -->
  <div class="filters-container">
    <div class="filters-row">
      <div class="filter-item">
        <label for="filter-user">{{ 'sales.filters.user' | translate }}</label>
        <p-inputGroup class="search-input">
          <p-inputGroupAddon>
            <i class="pi pi-search"></i>
          </p-inputGroupAddon>
          <input
            type="text"
            id="filter-user"
            pInputText
            [(ngModel)]="filterUserTextValue"
            [placeholder]="'sales.filters.userPlaceholder' | translate"
          />
        </p-inputGroup>
      </div>

      <div class="filter-item">
        <label for="filter-date-from">{{ 'sales.filters.dateFrom' | translate }}</label>
        <p-inputGroup>
          <p-inputGroupAddon>
            <i class="pi pi-calendar"></i>
          </p-inputGroupAddon>
          <p-datePicker
            id="filter-date-from"
            [(ngModel)]="filterDateFromValue"
            [showIcon]="false"
            [showClear]="true"
            dateFormat="dd/mm/yy"
            [firstDayOfWeek]="1"
            [placeholder]="'sales.filters.dateFromPlaceholder' | translate"
            [style]="{ width: '100%', border: 'none' }"
          />
        </p-inputGroup>
      </div>

      <div class="filter-item">
        <label for="filter-date-to">{{ 'sales.filters.dateTo' | translate }}</label>
        <p-inputGroup>
          <p-inputGroupAddon>
            <i class="pi pi-calendar"></i>
          </p-inputGroupAddon>
          <p-datePicker
            id="filter-date-to"
            [(ngModel)]="filterDateToValue"
            [showIcon]="false"
            [showClear]="true"
            dateFormat="dd/mm/yy"
            [firstDayOfWeek]="1"
            [placeholder]="'sales.filters.dateToPlaceholder' | translate"
            [style]="{ width: '100%', border: 'none' }"
          />
        </p-inputGroup>
      </div>

      <div class="filter-item">
        <label for="filter-delivered">{{ 'sales.filters.delivered' | translate }}</label>
        <p-inputGroup>
          <p-inputGroupAddon>
            <i class="pi pi-filter"></i>
          </p-inputGroupAddon>
          <p-select
            id="filter-delivered"
            [options]="deliveredOptions()"
            [(ngModel)]="filterDeliveredValue"
            optionLabel="label"
            optionValue="value"
            [placeholder]="'sales.filters.deliveredPlaceholder' | translate"
            [style]="{ width: '100%', border: 'none' }"
          />
        </p-inputGroup>
      </div>

      <div class="filter-actions">
        <p-button
          [label]="'common.clearFilters' | translate"
          icon="pi pi-times"
          (onClick)="clearFilters()"
          [text]="true"
          styleClass="p-button-secondary"
        />
      </div>
    </div>
  </div>

  <p-table
    [value]="filteredSales()"
    [loading]="salesService.isLoading()"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="{{ 'common.showing' | translate }} {first} {{ 'common.to' | translate }} {last} {{ 'common.of' | translate }} {totalRecords} {{ 'common.records' | translate }}"
    styleClass="p-datatable-striped"
    responsiveLayout="scroll"
    [sortMode]="'multiple'"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem" (click)="$event.stopPropagation()">
          <p-checkbox
            [binary]="true"
            [ngModel]="allSelectableSelected()"
            [ngModelOptions]="{standalone: true}"
            (ngModelChange)="toggleSelectAll()"
          />
        </th>
        <th pSortableColumn="createdAt" style="width: 10rem">
          {{ 'sales.table.date' | translate }}
          <p-sortIcon field="createdAt" />
        </th>
        <th pSortableColumn="userName" style="width: 12rem">
          {{ 'sales.table.user' | translate }}
          <p-sortIcon field="userName" />
        </th>
        <th class="text-right" style="width: 6rem">
          {{ 'sales.table.items' | translate }}
        </th>
        <th class="text-right" style="width: 8rem">
          {{ 'sales.table.subtotalWithoutTax' | translate }}
        </th>
        <th class="text-right" style="width: 8rem">
          {{ 'sales.table.taxAmount' | translate }}
        </th>
        <th class="text-right" pSortableColumn="totalAmount" style="width: 8rem">
          {{ 'sales.table.total' | translate }}
          <p-sortIcon field="totalAmount" />
        </th>
        <th class="text-right" pSortableColumn="paidAmount" style="width: 8rem">
          {{ 'sales.table.paid' | translate }}
          <p-sortIcon field="paidAmount" />
        </th>
        <th class="text-right" style="width: 8rem">
          {{ 'sales.table.pending' | translate }}
        </th>
        <th pSortableColumn="paymentStatus" style="width: 10rem">
          {{ 'sales.table.status' | translate }}
          <p-sortIcon field="paymentStatus" />
        </th>
        <th class="text-center" style="width: 8rem">
          {{ 'sales.table.delivered' | translate }}
        </th>
        <th class="text-center" style="width: 10rem">
          {{ 'common.actions' | translate }}
        </th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-sale>
      <tr class="clickable-row" (click)="viewDetail(sale)">
        <td (click)="$event.stopPropagation()">
          @if (canMarkAsPaid(sale)) {
            <p-checkbox
              [binary]="true"
              [ngModel]="isSaleSelected(sale.id)"
              [ngModelOptions]="{standalone: true}"
              (ngModelChange)="toggleSaleSelection(sale.id)"
            />
          }
        </td>
        <td>{{ sale.createdAt | date: 'dd/MM/yyyy HH:mm' }}</td>
        <td>{{ sale.userName || sale.userEmail }}</td>
        <td class="text-right">{{ sale.items.length }}</td>
        <td class="text-right">{{ getSubtotalWithoutTax(sale) | number: '1.2-2' }} €</td>
        <td class="text-right">
          @if (getTaxAmount(sale) > 0) {
            {{ getTaxAmount(sale) | number: '1.2-2' }} €
          } @else {
            <span class="text-secondary">—</span>
          }
        </td>
        <td class="text-right"><strong>{{ getTotalWithTax(sale) | number: '1.2-2' }} €</strong></td>
        <td class="text-right">{{ sale.paidAmount | number: '1.2-2' }} €</td>
        <td class="text-right">{{ getRemainingAmount(sale) | number: '1.2-2' }} €</td>
        <td>
          <p-tag
            [value]="getStatusLabel(sale.paymentStatus) | translate"
            [severity]="getStatusSeverity(sale.paymentStatus)"
          />
        </td>
        <td class="text-center" (click)="$event.stopPropagation()">
          <p-checkbox
            [(ngModel)]="sale.isDelivered"
            [binary]="true"
            (onChange)="toggleDelivered(sale)"
          />
        </td>
        <td class="text-center" (click)="$event.stopPropagation()">
          <div class="action-buttons">
            <p-button
              icon="pi pi-eye"
              [pTooltip]="'common.view' | translate"
              [rounded]="true"
              [text]="true"
              severity="info"
              (onClick)="viewDetail(sale)"
            />
            @if (canMarkAsPaid(sale)) {
              <p-button
                icon="pi pi-check-circle"
                [pTooltip]="'sales.actions.markAsPaid' | translate"
                [rounded]="true"
                [text]="true"
                severity="success"
                (onClick)="markAsPaid(sale)"
              />
            }
            <p-button
              icon="pi pi-trash"
              [pTooltip]="'common.delete' | translate"
              [rounded]="true"
              [text]="true"
              severity="danger"
              (onClick)="deleteOrder(sale)"
            />
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="12" class="text-center">
          {{ 'sales.noOrders' | translate }}
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
